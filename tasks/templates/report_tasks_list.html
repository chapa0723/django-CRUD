{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center py-3">
      
      <div>
        <h2 class="h4 mb-0 text-primary">
          <i class="bi bi-file-earmark-text me-2"></i>{{ report_title }}
        </h2>
        <small class="text-muted">
          Generado el {% now "d/m/Y H:i" %} | Total: {{ context.total }} tareas
        </small>
      </div>

      <form action="{{ request.path }}" method="get" class="d-flex align-items-center">
        <label for="days-select" class="form-label me-2 mb-0 fw-bold text-secondary">Período:</label>
        <select name="days" id="days-select" class="form-select form-select-sm border-secondary" 
                style="width: auto;" onchange="this.form.submit();">
          <option value="0" {% if context.period_days == 0 %}selected{% endif %}>Todo el tiempo</option>
          <option value="7" {% if context.period_days == 7 %}selected{% endif %}>Últimos 7 días</option>
          <option value="30" {% if context.period_days == 30 %}selected{% endif %}>Últimos 30 días</option>
          <option value="90" {% if context.period_days == 90 %}selected{% endif %}>Últimos 90 días</option>
        </select>
      </form>
      <div class="vr text-secondary mx-1"></div>

          <a href="{% url 'tasks_details_pdf' %}?{{ request.GET.urlencode }}" class="btn btn-danger" target="_blank">
        <i class="bi bi-file-pdf"></i> Descargar PDF
      </a>

          <a href="{% url 'reports' %}" class="btn btn-secondary btn-sm" title="Volver a Reportes">
            <i class="bi bi-arrow-left"></i> Volver a Reportes
          </a>

    </div>
  </div>

  {% if context.tasks %}
  <div class="card border-0 shadow-lg">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="py-3 ps-4">Nombre de la Tarea</th>
              <th class="py-3">Usuario</th>
              <th class="py-3">Fecha Creación</th>
              
              {% if report_type == 'all_tasks' or report_type == 'important_pending' %}
              <th class="py-3">Estado</th>
              {% endif %}
              
              {% if report_type == 'completed' or report_type == 'all_tasks' %}
              <th class="py-3">Completada el</th>
              {% endif %}
              
              <th class="py-3 text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for task in context.tasks %}
            <tr>
              <td class="ps-4">
                <div class="d-flex align-items-center">
                  {% if task.important %}
                    <i class="bi bi-star-fill text-warning me-2" title="Importante"></i>
                  {% endif %}
                  <div>
                    <span class="fw-bold d-block text-dark">{{ task.title }}</span>
                    <small class="text-muted">{{ task.description|truncatewords:8 }}</small>
                  </div>
                </div>
              </td>

              <td>
                <span class="badge bg-light text-dark border">
                  <i class="bi bi-person-fill"></i> {{ task.user.username }}
                </span>
              </td>

              <td>
                <small class="text-secondary">
                  <i class="bi bi-calendar3"></i> {{ task.created|date:"d/m/Y H:i" }}
                </small>
              </td>

              {% if report_type == 'all_tasks' or report_type == 'important_pending' %}
              <td>
                {% if task.datecompleted %}
                  <span class="badge bg-success rounded-pill">Completada</span>
                {% else %}
                  <span class="badge bg-warning text-dark rounded-pill">Pendiente</span>
                {% endif %}
              </td>
              {% endif %}

              {% if report_type == 'completed' or report_type == 'all_tasks' %}
              <td>
                {% if task.datecompleted %}
                  <small class="text-success fw-bold">
                    <i class="bi bi-check2-all"></i> {{ task.datecompleted|date:"d/m/Y H:i" }}
                  </small>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              {% endif %}

              <td class="text-end pe-4">
                <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% else %}
    <div class="alert alert-warning d-flex align-items-center mt-3" role="alert">
      <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2 fs-4"></i>
      <div>
        No hay tareas para mostrar en este período. Prueba seleccionando "Todo el tiempo".
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}